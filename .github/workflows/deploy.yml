name: Debug CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Create prod config
        run: |
          cat > src/main/resources/application-prod.properties << EOF
          spring.datasource.url=${{ secrets.DB_URL }}
          spring.datasource.username=${{ secrets.DB_USERNAME }}
          spring.datasource.password=${{ secrets.DB_PASSWORD }}
          jwt.secret=${{ secrets.JWT_SECRET }}
          jwt.access-token-validity=86400000
          jwt.refresh-token-validity=604800000
          kakao.client-id=${{ secrets.KAKAO_CLIENT_ID }}
          kakao.client-secret=${{ secrets.KAKAO_CLIENT_SECRET }}
          kakao.redirect-uri=${{ secrets.KAKAO_REDIRECT_URI }}
          kakao.token-uri=https://kauth.kakao.com/oauth/token
          kakao.user-info=https://kapi.kakao.com/v2/user/me
          spring.jpa.show-sql=false
          EOF
      
      - name: Build
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test
      
      - name: Deploy to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ubuntu/"
      
      # ë””ë²„ê¹…ìš© í™˜ê²½ ì²´í¬
      - name: Check Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "=== í™˜ê²½ ì²´í¬ ==="
            echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
            echo "Java ë²„ì „:"
            java -version || echo "âŒ Javaê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ!"
            echo ""
            echo "JAR íŒŒì¼ í™•ì¸:"
            ls -la build/libs/ || echo "âŒ JAR íŒŒì¼ ì—†ìŒ!"
            echo ""
            echo "ì‹¤í–‰ ì¤‘ì¸ Java í”„ë¡œì„¸ìŠ¤:"
            ps aux | grep java || echo "Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            echo ""
            echo "í¬íŠ¸ 8080 ì‚¬ìš© í˜„í™©:"
            netstat -tlnp | grep :8080 || echo "í¬íŠ¸ 8080 ì‚¬ìš© ì•ˆ í•¨"
      
      # ì‹¤ì œ ë°°í¬
      - name: Deploy Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "=== ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹œì‘ ==="
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ..."
            pkill -f "biddy-api" || echo "ì¢…ë£Œí•  í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            sleep 3
            
            # JAR íŒŒì¼ ì¡´ì¬ í™•ì¸
            if [ ! -f "build/libs/biddy-api-0.0.1-SNAPSHOT.jar" ]; then
              echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
              echo "í˜„ì¬ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la
              echo "build/libs ë‚´ìš©:"
              ls -la build/libs/ || echo "build/libs ë””ë ‰í† ë¦¬ ì—†ìŒ"
              exit 1
            fi
            
            # Java ì„¤ì¹˜ í™•ì¸
            if ! command -v java &> /dev/null; then
              echo "âŒ Javaê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
              sudo apt update
              sudo apt install -y openjdk-17-jdk
            fi
            
            echo "Java ë²„ì „ í™•ì¸:"
            java -version
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘..."
            nohup java -jar \
              -Dspring.profiles.active=prod \
              -Xms256m -Xmx512m \
              build/libs/biddy-api-0.0.1-SNAPSHOT.jar > app.log 2>&1 &
            
            APP_PID=$!
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ PID: $APP_PID"
            echo $APP_PID > app.pid
            
            # ì‹œì‘ í™•ì¸
            echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 10
            
            if ps -p $APP_PID > /dev/null; then
              echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
              echo "ğŸ“ ë¡œê·¸ í™•ì¸: tail -f app.log"
            else
              echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨!"
              echo "ì—ëŸ¬ ë¡œê·¸:"
              tail -20 app.log 2>/dev/null || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
              exit 1
            fi
